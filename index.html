<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple PWA — Bitshared</title>

  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json" />

  <!-- Theme color for mobile -->
  <meta name="theme-color" content="#2E7D32"/>

  <!-- favicon / icon (optional) -->
  <link rel="icon" href="/icons/icon-192.png" />

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:1.2rem; background:#f5f5f5; color:#222; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:1rem; }
    .logo { width:48px; height:48px; border-radius:8px; background:#2E7D32; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
    main { background:#fff; padding:1rem; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
    button { padding:.6rem .9rem; border:0; border-radius:6px; background:#2E7D32; color:#fff; cursor:pointer; }
    #status { margin-top:.8rem; color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <header>
    <div class="logo">P</div>
    <h1>Simple PWA</h1>
  </header>

  <main>
    <p>Halo! Ini PWA sederhana. Bisa di-install di Android / Chrome.</p>

    <p>
      <button id="installBtn" style="display:none">Install App</button>
      <button id="refreshBtn">Cek Update / Reload</button>
    </p>

    <p id="status">Status: sedang memeriksa service worker...</p>

    <hr/>
    <h3>Offline test</h3>
    <p>Jika offline, halaman ini akan tetap tampil (cached) — coba matikan koneksi lalu reload.</p>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
    const installBtn = document.getElementById('installBtn');

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
      .then(reg => {
        statusEl.textContent = 'Status: Service worker terdaftar.';
        // listen updatefound
        if (reg.waiting) {
          statusEl.textContent = 'Update tersedia — refresh untuk memakai versi baru.';
        }
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed') {
              if (navigator.serviceWorker.controller) {
                statusEl.textContent = 'Update terpasang. Klik "Cek Update / Reload" untuk reload.';
              } else {
                statusEl.textContent = 'Konten telah di-cache untuk offline use.';
              }
            }
          });
        });
      })
      .catch(err => {
        statusEl.textContent = 'Gagal daftar service worker: ' + err;
      });

      // message to skip waiting when user reloads
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('controllerchange');
      });
    } else {
      statusEl.textContent = 'Service worker tidak didukung di browser ini.';
    }

    // Manual refresh / activate new service worker
    refreshBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Mencoba reload dan aktifkan update (jika ada)...';
      const reg = await navigator.serviceWorker.getRegistration();
      if (!reg) return location.reload();
      if (reg.waiting) {
        // tell waiting worker to skipWaiting
        reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        reg.waiting.addEventListener('statechange', e => {
          if (e.target.state === 'activated') location.reload();
        });
      } else {
        location.reload();
      }
    });

    // Install prompt handling (show button)
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-block';
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if (choice.outcome === 'accepted') {
        installBtn.style.display = 'none';
        statusEl.textContent = 'Aplikasi terinstal / user menerima prompt.';
      } else {
        statusEl.textContent = 'User menolak instalasi.';
      }
      deferredPrompt = null;
    });

    // Simple online/offline indicator
    function updateOnlineStatus() {
      statusEl.textContent = navigator.onLine ? 'Online' : 'Offline (menggunakan cache jika tersedia)';
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  </script>
</body>
</html>